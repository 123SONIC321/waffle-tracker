<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waffle Optimizer</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #bb86fc;
            --green: #03dac6; --red: #cf6679; --yellow: #ffb74d;
            --text: #f5f5f5; --sub: #aaaaaa; --disabled: #333;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 15px;
            display: flex; justify-content: center;
            /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            touch-action: manipulation; 
        }
        .app-container {
            width: 100%; max-width: 450px;
            background: var(--card); padding: 20px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 20px;
        }
        h1 {
            text-align: center; color: var(--accent); font-size: 1.4rem; margin: 0;
        }

        /* --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø± --- */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .stat-box {
            background: #2d2d2d; padding: 12px; border-radius: 12px; text-align: center;
            border: 1px solid #3d3d3d;
        }
        .stat-label { font-size: 0.75rem; color: var(--sub); margin-bottom: 4px; }
        .stat-value { font-size: 1.6rem; font-weight: 900; }
        .val-green { color: var(--green); }
        .val-yellow { color: var(--yellow); }

        /* --- Ø¨Ø®Ø´ ÙˆÛŒØ²Ø§Ø±Ø¯ (Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø± Ø±ØªØ¨Ù‡) --- */
        .wizard-card {
            background: #252525; border-radius: 16px; padding: 15px;
            border: 1px solid #333; position: relative; overflow: hidden;
        }
        .stage-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .stage-title { font-size: 1.1rem; font-weight: bold; color: var(--text); }
        .stage-badge { 
            background: var(--accent); color: #000; padding: 2px 10px; 
            border-radius: 20px; font-size: 0.8rem; font-weight: bold; 
        }
        
        /* Ú¯Ø±ÛŒØ¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú© */
        .rank-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .rank-btn {
            background: #333; border: none; border-radius: 12px; padding: 15px 10px;
            color: #fff; font-family: 'Vazirmatn', sans-serif; font-size: 0.95rem;
            cursor: pointer; transition: all 0.1s; position: relative;
        }
        .rank-btn:active { transform: scale(0.96); }
        .rank-btn small { display: block; font-size: 0.7rem; opacity: 0.7; margin-top: 4px; }
        
        .btn-win { background: #3d3d3d; border: 1px solid #555; }
        .btn-win:hover { background: #444; border-color: var(--accent); }
        
        .btn-loss { 
            grid-column: span 2; /* Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø®Øª Ú©Ù„ Ø¹Ø±Ø¶ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯ */
            background: rgba(207, 102, 121, 0.1); color: var(--red); 
            border: 1px solid var(--red); font-weight: bold;
        }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ù¾Ø§ÛŒÛŒÙ† ÙˆÛŒØ²Ø§Ø±Ø¯ */
        .wizard-controls {
            display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;
        }
        .ctrl-btn {
            background: transparent; border: none; color: var(--sub); font-family: inherit;
            font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .ctrl-btn:disabled { opacity: 0.3; cursor: default; }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ø¯Ù (Target) --- */
        .target-control {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: #1a1a1a; padding: 10px; border-radius: 12px; margin-top: 10px;
        }
        .t-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #333; color: #fff; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .t-btn:active { background: var(--accent); color: #000; }
        .t-btn:disabled { background: #222; color: #555; cursor: not-allowed; }
        
        .t-display { font-size: 1.5rem; font-weight: bold; color: var(--text); min-width: 50px; text-align: center; }

        /* --- Ø¨Ø®Ø´ Ù…Ø´Ø§ÙˆØ± --- */
        .advisor-box {
            font-size: 0.85rem; color: var(--sub); text-align: center;
            padding: 10px; border-radius: 10px; background: #222; border: 1px dashed #444;
        }
        .adv-highlight { color: var(--accent); font-weight: bold; }

        /* Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª */
        .reset-link { 
            text-align: center; color: #444; font-size: 0.75rem; margin-top: 10px; cursor: pointer; 
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ğŸ§‡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø² ÙˆØ§ÙÙ„</h1>

    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-label">ÙˆØ§ÙÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ù…Ø¹â€ŒØ´Ø¯Ù‡</div>
            <div class="stat-value val-green" id="totalDisplay">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ÙØ§ØµÙ„Ù‡ ØªØ§ Ù‡Ø¯Ù</div>
            <div class="stat-value val-yellow" id="gapDisplay">94</div>
        </div>
    </div>

    <div class="wizard-card">
        <div class="stage-header">
            <span class="stage-title" id="stageTitle">Ø§Ø³ØªÛŒØ¬ Û±</span>
            <span class="stage-badge" id="currentRunBadge">Ø±Ø§Ù† ÙØ¹Ù„ÛŒ: Û°</span>
        </div>

        <div class="rank-grid" id="buttonsArea">
            </div>

        <div class="wizard-controls">
            <button class="ctrl-btn" id="btnBack" onclick="goBackStep()">
                â†©ï¸ Ø§ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ÛŒ
            </button>
            <button class="ctrl-btn" style="color:var(--yellow)" onclick="finishRunEarly()">
                âœ¨ ÙØ¹Ù„Ø§ Ø«Ø¨Øª Ú©Ù† (Ù†Ø§ØªÙ…Ø§Ù…)
            </button>
        </div>
    </div>

    <div class="advisor-box" id="advisorText">
        Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø³ÛŒØ±...
    </div>

    <div style="text-align:center; margin-top:10px;">
        <label style="font-size:0.8rem; color:#666;">Ù‡Ø¯Ù Ù†Ù‡Ø§ÛŒÛŒ (Target Cap)</label>
        <div class="target-control">
            <button class="t-btn" id="btnMinus" onclick="changeTarget(-1)">âˆ’</button>
            <div class="t-display" id="targetVal">94</div>
            <button class="t-btn" id="btnPlus" onclick="changeTarget(1)">+</button>
        </div>
    </div>

    <div class="reset-link" onclick="resetAll()">ğŸ—‘ï¸ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
</div>

<script>
    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø«ÙˆØ§Ø¨Øª ---
    const REWARDS = {1: 10, 2: 12, 3: 14, 4: 16, 5: 18};
    const BONUS = {1: 5, 2: 4, 3: 3, 4: 2};
    const MIN_TARGET = 90;
    const MAX_TARGET = 200;

    // ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ (State)
    let state = {
        total: 0,        // ÙˆØ§ÙÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ (Ø¨Ø§Ù†Ú© Ø´Ø¯Ù‡)
        target: 94,      // Ù‡Ø¯Ù
        // ÙˆØ¶Ø¹ÛŒØª Ø±Ø§Ù† ÙØ¹Ù„ÛŒ (Temporary Run)
        currentStage: 1,
        runScore: 0,
        history: []      // Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø± Ø­ÛŒÙ† Ø±Ø§Ù† (Undo)
    };

    // --- Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ---
    window.onload = () => {
        const saved = localStorage.getItem('waffleState_v8');
        if (saved) state = JSON.parse(saved);
        renderUI();
    };

    function save() {
        localStorage.setItem('waffleState_v8', JSON.stringify(state));
        renderUI();
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ---

    // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø±ØªØ¨Ù‡ (Ø¨Ø±Ø¯)
    function handleWin(rank) {
        const gain = REWARDS[state.currentStage] + BONUS[rank];
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø­Ø±Ú©Øª Ø¨Ø±Ø§ÛŒ Undo
        state.history.push({
            stage: state.currentStage,
            gain: gain,
            type: 'win'
        });

        state.runScore += gain;
        state.currentStage++;

        // Ø§Ú¯Ø± Ø§Ø³ØªÛŒØ¬ Ûµ ØªÙ…Ø§Ù… Ø´Ø¯
        if (state.currentStage > 5) {
            finishRun("ğŸ‰ Ø±Ø§Ù† Ú©Ø§Ù…Ù„ Ø´Ø¯!");
        } else {
            save(); // ÙÙ‚Ø· Ø±Ù†Ø¯Ø± Ø¨Ø¹Ø¯ÛŒ
        }
    }

    // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø®Øª
    function handleLoss() {
        // Ø¯Ø± Ø¨Ø§Ø®ØªØŒ Ø±Ø§Ù† Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ÙÙ‚Ø· Û± ÙˆØ§ÙÙ„ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ù‡ Ú©Ù„
        // Ø§Ù…Ø§ Ù‚Ø¨Ù„Ø´ Ø¨Ø§ÛŒØ¯ Ù‡Ø±Ú†ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø±Ø§Ù† Ø¬Ù…Ø¹ Ú©Ø±Ø¯ÛŒÙ… (runScore) Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒÙ… Ø¨Ù‡ Ú©Ù„
        
        const finalGainFromRun = state.runScore + 1; // Ù‡Ø±Ú†ÛŒ Ø¨Ø±Ø¯ÛŒÙ… + Û± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø®Øª
        state.total += finalGainFromRun;
        
        // Ø±ÛŒØ³Øª Ø±Ø§Ù†
        resetRunState();
        save();
    }

    // Ø«Ø¨Øª Ø±Ø§Ù† Ù†Ø§ØªÙ…Ø§Ù… (Ø¯Ú©Ù…Ù‡ Ù¾Ø§ÛŒÛŒÙ†)
    function finishRunEarly() {
        if (state.runScore === 0) return;
        state.total += state.runScore;
        resetRunState();
        save();
    }

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø±Ø¯Ù† Ø±Ø§Ù†
    function finishRun(msg) {
        state.total += state.runScore;
        resetRunState();
        save();
    }

    function resetRunState() {
        state.currentStage = 1;
        state.runScore = 0;
        state.history = [];
    }

    // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª (Undo)
    function goBackStep() {
        if (state.history.length === 0) return;
        
        const lastMove = state.history.pop();
        state.runScore -= lastMove.gain;
        state.currentStage = lastMove.stage;
        save();
    }

    // ØªØºÛŒÛŒØ± Ù‡Ø¯Ù
    function changeTarget(delta) {
        const newVal = state.target + delta;
        if (newVal >= MIN_TARGET && newVal <= MAX_TARGET) {
            state.target = newVal;
            save();
        }
    }

    function resetAll() {
        if(confirm("Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- Ø±Ù†Ø¯Ø± Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ ---
    function renderUI() {
        // 1. Ø¢Ù…Ø§Ø± Ø¨Ø§Ù„Ø§
        document.getElementById('totalDisplay').innerText = state.total;
        const gap = state.target - state.total;
        document.getElementById('gapDisplay').innerText = gap;

        // 2. Ú©Ù†ØªØ±Ù„ Ù‡Ø¯Ù
        document.getElementById('targetVal').innerText = state.target;
        document.getElementById('btnMinus').disabled = (state.target <= MIN_TARGET);
        document.getElementById('btnPlus').disabled = (state.target >= MAX_TARGET);

        // 3. ÙˆÛŒØ²Ø§Ø±Ø¯ (Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§)
        const stage = state.currentStage;
        document.getElementById('stageTitle').innerText = `Ø§Ø³ØªÛŒØ¬ ${stage}`;
        document.getElementById('currentRunBadge').innerText = `Ø¯Ø± Ø§ÛŒÙ† Ø±Ø§Ù†: ${state.runScore}`;
        document.getElementById('btnBack').disabled = (state.history.length === 0);

        const grid = document.getElementById('buttonsArea');
        grid.innerHTML = '';

        // ØªÙˆÙ„ÛŒØ¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø¯ (Ø±Ù†Ú© Û± ØªØ§ Û´)
        for (let r = 1; r <= 4; r++) {
            const reward = REWARDS[stage] + BONUS[r];
            const btn = document.createElement('button');
            btn.className = 'rank-btn btn-win';
            btn.innerHTML = `Ø±ØªØ¨Ù‡ ${r} <small>+${reward} ÙˆØ§ÙÙ„</small>`;
            btn.onclick = () => handleWin(r);
            grid.appendChild(btn);
        }

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø®Øª
        const loseBtn = document.createElement('button');
        loseBtn.className = 'rank-btn btn-loss';
        loseBtn.innerHTML = `ğŸ’€ Ø¨Ø§Ø®ØªÙ… Ø¯Ø± Ø§Ø³ØªÛŒØ¬ ${stage} <small>Ú©Ù„Ø§Ù‹ +1 ÙˆØ§ÙÙ„ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†</small>`;
        loseBtn.onclick = () => handleLoss();
        grid.appendChild(loseBtn);

        // 4. Ù…Ø´Ø§ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯
        updateAdvisor(gap);
    }

    function updateAdvisor(gap) {
        const el = document.getElementById('advisorText');
        const total = state.total;
        
        if (total >= 95) {
            el.innerHTML = `<span style="color:var(--red)">â›” Ø³Ù‚Ù Ù¾Ø± Ø´Ø¯! (Û¹Ûµ+) Ø§ÛŒÙˆÙ†Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯.</span>`;
            el.style.borderColor = "var(--red)";
        } else if (total === state.target) {
            el.innerHTML = `<span style="color:var(--green)">ğŸ‰ Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ Perfect Run Ø¨Ø±Ùˆ (ØªØ§ Ø¢Ø®Ø± Ø¨Ø¨Ø±).</span>`;
            el.style.borderColor = "var(--green)";
        } else if (total + 1 === 95) {
            el.innerHTML = `<span style="color:var(--red)">âš ï¸ ØªÙ„Ù‡! Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø¨Ø§Ø²ÛŒ. Ø­ØªÙ…Ø§ Ø§Ø³ØªÛŒØ¬ Û± Ø±Ùˆ Ø¨Ø¨Ø±.</span>`;
            el.style.borderColor = "var(--red)";
        } else {
            // Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
            let msg = "";
            if (gap >= 73) msg = "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b>Deep Run</b> (ØªØ§ Ø§Ø³ØªÛŒØ¬ Û´ Ø¨Ø¨Ø±ØŒ Ø§Ø³ØªÛŒØ¬ Ûµ Ø¨Ø¨Ø§Ø²)";
            else if (gap >= 16) msg = "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b>Short Run</b> (Ø§Ø³ØªÛŒØ¬ Û± Ø¨Ø¨Ø±ØŒ Ø§Ø³ØªÛŒØ¬ Û² Ø¨Ø¨Ø§Ø²)";
            else msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b>Gap Fill</b> (${gap} Ø¨Ø§Ø± Ù¾Ø´Øª Ù‡Ù… Ø¯Ø± Ø§Ø³ØªÛŒØ¬ Û± Ø¨Ø¨Ø§Ø²)`;
            
            el.innerHTML = msg;
            el.style.borderColor = "#444";
        }
    }
</script>

</body>
</html>
