<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙˆØ§ÙÙ„</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --bg: #0f0f0f; 
            --card: #1a1a1a; 
            --accent: #bb86fc;
            --accent-glow: rgba(187, 134, 252, 0.3);
            --green: #00e676; 
            --green-glow: rgba(0, 230, 118, 0.4);
            --red: #ff5252; 
            --red-glow: rgba(255, 82, 82, 0.4);
            --text: #ffffff; 
            --sub: #b0b0b0;
            --yellow: #ffeb3b;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 15px;
            display: flex; justify-content: center;
            touch-action: manipulation; 
            overflow-x: hidden;
        }
        .app-container {
            width: 100%; max-width: 450px;
            background: var(--card); padding: 20px;
            border-radius: 24px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; gap: 18px;
            border: 1px solid #333;
            position: relative;
        }
        
        /* --- Ù‡Ø¯Ø± Ùˆ Ø¯Ú©Ù…Ù‡ Info --- */
        h1 {
            text-align: center; color: var(--accent); 
            font-size: 1.5rem; /* Ø³Ø§ÛŒØ² Ø§ØµÙ„ÛŒ Ú©Ø¯ 1 */
            margin: 5px 0 0 0;
            text-shadow: 0 0 15px var(--accent-glow);
            padding: 0 40px;
            line-height: 1.6;
        }

        .info-btn {
            position: absolute; top: 15px; left: 15px;
            width: 32px; height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent); color: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; z-index: 10;
            animation: pulse-glow 2.5s infinite;
            font-family: serif;
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(187, 134, 252, 0.4); }
            50% { box-shadow: 0 0 10px 2px rgba(187, 134, 252, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(187, 134, 252, 0); }
        }

        /* --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø± --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box {
            background: #252525; padding: 12px; border-radius: 16px; text-align: center;
            border: 1px solid #333; position: relative; overflow: hidden;
        }
        .stat-label { font-size: 0.7rem; color: var(--sub); margin-bottom: 5px; line-height: 1.4; }
        .stat-value { font-size: 1.6rem; font-weight: 900; letter-spacing: 1px; transition: color 0.3s; }
        .val-green { color: var(--green); text-shadow: 0 0 10px var(--green-glow); }
        
        /* Ø§ÙÚ©Øª ÙÙ„Ø´ Ø²Ø¯Ù† Ù…ÙˆÙ‚Ø¹ ØªØºÛŒÛŒØ± Ø¹Ø¯Ø¯ */
        @keyframes flash-green { 0% { background-color: rgba(0,230,118,0); } 50% { background-color: rgba(0,230,118,0.2); } 100% { background-color: rgba(0,230,118,0); } }
        .flash-update { animation: flash-green 0.4s ease-out; }

        /* --- ÙˆÛŒØ²Ø§Ø±Ø¯ (Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ) --- */
        .wizard-card {
            background: #222; border-radius: 20px; padding: 18px;
            border: 1px solid #333; position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            min-height: 260px; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .stage-header {
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 15px; gap: 6px;
        }
        .stage-title { font-size: 1.2rem; font-weight: bold; color: var(--text); text-shadow: 0 0 5px rgba(255,255,255,0.2); }
        .stage-badge { 
            background: rgba(187, 134, 252, 0.1); color: var(--accent); 
            padding: 3px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            border: 1px solid rgba(187, 134, 252, 0.3);
        }
        
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .rank-btn {
            border: none; border-radius: 14px; padding: 14px 8px;
            color: #fff; font-family: 'Vazirmatn', sans-serif; font-size: 0.95rem;
            cursor: pointer; position: relative; transition: transform 0.1s;
            background: linear-gradient(145deg, #333, #2a2a2a); border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .rank-btn:active { transform: scale(0.96); }
        .rank-btn small { display: block; font-size: 0.7rem; opacity: 0.8; margin-top: 4px; }
        
        .btn-loss { 
            grid-column: span 2; background: linear-gradient(145deg, #2d1a1a, #251515);
            color: var(--red); border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .wizard-controls {
            display: flex; justify-content: space-between; margin-top: 15px; padding-top: 12px; 
            border-top: 1px solid #333;
        }
        .ctrl-btn {
            background: transparent; border: none; color: var(--sub); 
            font-family: inherit; font-size: 0.8rem; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; padding: 8px;
        }

        /* --- Ù…Ø´Ø§ÙˆØ± Ùˆ ØªØ§Ø±Ú¯Øª --- */
        .advisor-box {
            font-size: 0.85rem; color: var(--sub); text-align: center;
            padding: 12px; border-radius: 12px; background: #202020; 
            border: 1px dashed #444; line-height: 1.6;
        }

        .target-control {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: #222; padding: 6px; border-radius: 14px; margin-top: 8px;
            border: 1px solid #333; width: fit-content; margin-left: auto; margin-right: auto;
        }
        .t-btn {
            width: 38px; height: 38px; border-radius: 10px; border: none;
            background: #333; color: #fff; font-size: 1.2rem; cursor: pointer;
        }
        .t-btn:disabled { background: #1a1a1a; color: #444; cursor: not-allowed; }
        .t-display { font-size: 1.4rem; font-weight: 900; min-width: 50px; text-align: center; }

        /* --- Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ú©Ø´ÙˆÛŒÛŒ) --- */
        .history-drawer {
            background: #1a1a1a; border-top: 1px solid #333;
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            border-radius: 0 0 24px 24px; margin: 0 -20px -20px -20px; /* Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† */
        }
        .history-content { padding: 15px; }
        .log-item {
            display: flex; justify-content: space-between; font-size: 0.8rem;
            padding: 6px 0; border-bottom: 1px solid #252525; color: #aaa;
        }
        .log-green { color: var(--green); } .log-red { color: var(--red); }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§Ù‡Ù†Ù…Ø§ (Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø¯ Û±) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100;
            padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: #1a1a1a; width: 100%; max-width: 400px;
            border-radius: 20px; padding: 25px; border: 1px solid var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
            position: relative; text-align: right; color: #eee;
            max-height: 80vh; overflow-y: auto; /* Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }
        .modal-close {
            position: absolute; top: 15px; left: 15px;
            background: #333; color: #fff; border: none;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            font-weight: bold;
        }
        .modal-h2 { color: var(--accent); margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-p { font-size: 0.9rem; line-height: 1.8; color: #ccc; margin-bottom: 10px; }
        .modal-badge { background: #333; padding: 2px 6px; border-radius: 4px; color: var(--accent); font-size: 0.8rem; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="info-btn" onclick="openHelp()">i</div>
    <h1>ğŸ§‡ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙˆØ§ÙÙ„ ğŸ§‡</h1>

    <div class="dashboard">
        <div class="stat-box" id="totalBox">
            <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§ÙÙ„Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§ Ø§Ù„Ø§Ù† Ú¯Ø±ÙØªÛŒ</div>
            <div class="stat-value val-green" id="totalDisplay">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ÙØ§ØµÙ„Ù‡ ØªØ§ Ù‡Ø¯Ù</div>
            <div class="stat-value" style="color:var(--yellow)" id="gapDisplay">94</div>
        </div>
    </div>

    <div class="wizard-card">
        <div id="wizardContent" class="fade-in">
            <div class="stage-header">
                <span class="stage-title" id="stageTitle">Ø±ØªØ¨Ù‡â€ŒØª ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ Û±</span>
                <span class="stage-badge" id="currentRunBadge">ÙˆØ§ÙÙ„Ø§ÛŒ Ø§ÛŒÙ† Ø±Ø§Ù†: Û°</span>
            </div>

            <div class="rank-grid" id="buttonsArea"></div>
        </div>

        <div class="wizard-controls">
            <button class="ctrl-btn" id="btnBack" onclick="goBackStep()">â†©ï¸ Ø§ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ÛŒ</button>
            <button class="ctrl-btn" style="color:var(--accent); font-weight:bold;" onclick="toggleHistory()">ğŸ“œ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
        </div>
    </div>

    <div class="advisor-box" id="advisorText">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</div>

    <div style="text-align:center; margin-top:5px;">
        <label style="font-size:0.7rem; color:#666;">Ù‡Ø¯Ù Ù†Ù‡Ø§ÛŒÛŒ (Target Cap)</label>
        <div class="target-control">
            <button class="t-btn" id="btnMinus" onclick="changeTarget(-1)">âˆ’</button>
            <div class="t-display" id="targetVal">94</div>
            <button class="t-btn" id="btnPlus" onclick="changeTarget(1)">+</button>
        </div>
    </div>

    <div style="text-align:center; color:#444; font-size:0.7rem; margin-top:15px; cursor:pointer;" onclick="resetAll()">ğŸ—‘ï¸ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>

    <div class="history-drawer" id="historyDrawer">
        <div class="history-content" id="historyList">
            <div style="text-align:center; font-size:0.8rem;">Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="helpModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeHelp()">âœ•</button>
        <h2 class="modal-h2">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ğŸ§‡</h2>
        <p class="modal-p">
            Ù‡Ø¯Ù Ù…Ø§ ÙØ±ÛŒØ¨ Ø¯Ø§Ø¯Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø§Ø² Ø³Ù‚Ù <b>Û¹Ûµ ÙˆØ§ÙÙ„</b> Ùˆ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø­Ø¯ÙˆØ¯ Û±Û¸Û¹ ÙˆØ§ÙÙ„ Ø¯Ø± Ø±ÙˆØ² Ø§Ø³Øª.
        </p>
        <p class="modal-p">
            <b>Û±. Ù‡Ø¯Ùâ€ŒÚ¯Ø°Ø§Ø±ÛŒ (Û¹Û° ØªØ§ Û¹Û´):</b><br>
            Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø·ÙˆØ±ÛŒ Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§ÙÙ„â€ŒÙ‡Ø§ÛŒØªØ§Ù† Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ù‡ Ø¹Ø¯Ø¯ <b>Û¹Û´</b> (ÛŒØ§ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø¢Ù†) Ø¨Ø±Ø³Ø¯ØŒ Ø§Ù…Ø§ Ù‡Ø±Ú¯Ø² Û¹Ûµ Ù†Ø´ÙˆØ¯.
        </p>
        <p class="modal-p">
            <b>Û². Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§:</b><br>
            ğŸ”¹ <span class="modal-badge">Deep Run</span>: Ù…Ø±Ø§Ø­Ù„ Û± ØªØ§ Û´ Ø±Ø§ Ø¨Ø¨Ø±ÛŒØ¯ØŒ Ø§Ù…Ø§ Ù…Ø±Ø­Ù„Ù‡ Ûµ Ø±Ø§ Ø¹Ù…Ø¯Ø§Ù‹ Ø¨Ø¨Ø§Ø²ÛŒØ¯ (Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ú©Ø§Ù¾).<br>
            ğŸ”¹ <span class="modal-badge">Gap Fill</span>: Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù…ØŒ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Û± Ø³Ø±ÛŒØ¹ Ø¨Ø¨Ø§Ø²ÛŒØ¯ (Ù‡Ø± Ø¨Ø§Ø®Øª = Û± ÙˆØ§ÙÙ„).
        </p>
        <p class="modal-p">
            <b>Û³. Ø­Ø±Ú©Øª Ù†Ù‡Ø§ÛŒÛŒ (Perfect Run):</b><br>
            ÙˆÙ‚ØªÛŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ù‡ Û¹Û´ Ø±Ø³ÛŒØ¯ÛŒØ¯ØŒ ÛŒÚ© Ø¯Ø³Øª Ú©Ø§Ù…Ù„ Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ ØªÙ…Ø§Ù… Ù…Ø±Ø§Ø­Ù„ Û± ØªØ§ Ûµ Ø±Ø§ Ø¨Ø¨Ø±ÛŒØ¯ ØªØ§ Ø¬Ø§ÛŒØ²Ù‡ Ø¯ÙˆØ¨Ù„ Ø¨Ú¯ÛŒØ±ÛŒØ¯!
        </p>
    </div>
</div>

<script>
    const REWARDS = {1: 10, 2: 12, 3: 14, 4: 16, 5: 18};
    const BONUS = {1: 5, 2: 4, 3: 3, 4: 2};
    const MIN_TARGET = 60; const MAX_TARGET = 94;

    let state = { total: 0, target: 94, currentStage: 1, runScore: 0, history: [] };

    window.onload = () => {
        const saved = localStorage.getItem('waffleState_v11');
        if (saved) state = JSON.parse(saved);
        if(state.target > MAX_TARGET) state.target = MAX_TARGET;
        if(state.target < MIN_TARGET) state.target = MIN_TARGET;
        renderUI();
    };

    function save() {
        localStorage.setItem('waffleState_v11', JSON.stringify(state));
        renderUI();
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¢Ù†ÛŒ (Ø§Ø² Ú©Ø¯ Û²) ---
    function handleWin(rank) {
        const gain = REWARDS[state.currentStage] + BONUS[rank];
        
        // 1. Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¢Ù†ÛŒ Ø¨Ù‡ Ú©Ù„
        state.total += gain;
        
        // 2. Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        state.history.push({ 
            stage: state.currentStage, 
            gain: gain, 
            type: 'win',
            desc: `Ø¨Ø±Ø¯ Ø¯Ø± Ø§Ø³ØªÛŒØ¬ ${state.currentStage} (Ø±ØªØ¨Ù‡ ${rank})` // ÙØ§Ø±Ø³ÛŒ Ø´Ø¯
        });

        // 3. Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø±Ø§Ù†
        state.runScore += gain;
        state.currentStage++;

        // Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
        triggerAnimation();
        flashTotal();

        if (state.currentStage > 5) {
            setTimeout(() => {
                alert("ğŸ‰ Ø±Ø§Ù† Ú©Ø§Ù…Ù„ Ø´Ø¯! ÙˆØ§ÙÙ„â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.");
                resetRunState();
                save();
            }, 300);
        } else {
            save();
        }
    }

    function handleLoss() {
        // Ø¯Ø± Ø¨Ø§Ø®ØªØŒ ÙÙ‚Ø· 1 ÙˆØ§ÙÙ„ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        state.total += 1;
        
        state.history.push({
            stage: state.currentStage,
            gain: 1,
            type: 'loss',
            desc: `Ø¨Ø§Ø®Øª Ø¯Ø± Ø§Ø³ØªÛŒØ¬ ${state.currentStage}` // ÙØ§Ø±Ø³ÛŒ Ø´Ø¯
        });

        triggerAnimation();
        flashTotal();
        
        // Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†
        resetRunState();
        save();
    }

    function resetRunState() {
        state.currentStage = 1;
        state.runScore = 0;
    }

    function goBackStep() {
        if (state.history.length === 0) return;
        const lastMove = state.history.pop();
        
        // Ú©Ø³Ø± Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¢Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
        state.total -= lastMove.gain;
        
        if (lastMove.type === 'win') {
            state.runScore -= lastMove.gain;
            state.currentStage = lastMove.stage;
        }
        // Ø¯Ø± Ø­Ø§Ù„Øª Ø¨Ø§Ø®ØªØŒ ÙÙ‚Ø· Ø§Ù…ØªÛŒØ§Ø² Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± Ø§Ø³ØªÛŒØ¬ Û± Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
        
        save();
    }

    // --- UI Updates ---
    function triggerAnimation() {
        const el = document.getElementById('wizardContent');
        el.classList.remove('fade-in');
        void el.offsetWidth; // Trigger reflow
        el.classList.add('fade-in');
    }

    function flashTotal() {
        const el = document.getElementById('totalBox');
        el.classList.add('flash-update');
        setTimeout(() => el.classList.remove('flash-update'), 400);
    }

    function changeTarget(delta) {
        const newVal = state.target + delta;
        if (newVal >= MIN_TARGET && newVal <= MAX_TARGET) {
            state.target = newVal;
            save();
        }
    }

    function resetAll() {
        if(confirm("Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) { localStorage.clear(); location.reload(); }
    }

    // --- History Drawer ---
    function toggleHistory() {
        const drawer = document.getElementById('historyDrawer');
        if (drawer.style.maxHeight) { drawer.style.maxHeight = null; } 
        else { drawer.style.maxHeight = drawer.scrollHeight + "px"; }
    }

    // --- Render ---
    function renderUI() {
        // Stats
        document.getElementById('totalDisplay').innerText = state.total;
        const gap = state.target - state.total;
        document.getElementById('gapDisplay').innerText = gap;
        document.getElementById('targetVal').innerText = state.target;
        
        // Buttons logic
        document.getElementById('btnMinus').disabled = (state.target <= MIN_TARGET);
        document.getElementById('btnPlus').disabled = (state.target >= MAX_TARGET);

        // Wizard
        const stage = state.currentStage;
        document.getElementById('stageTitle').innerText = `Ø±ØªØ¨Ù‡â€ŒØª ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ ${stage}`;
        document.getElementById('currentRunBadge').innerText = `ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§ÙÙ„Ø§ÛŒ Ø§ÛŒÙ† Ø±Ø§Ù†: ${state.runScore}`;
        document.getElementById('btnBack').disabled = (state.history.length === 0);

        // Generate Buttons
        const grid = document.getElementById('buttonsArea');
        grid.innerHTML = '';
        for (let r = 1; r <= 4; r++) {
            const reward = REWARDS[stage] + BONUS[r];
            const btn = document.createElement('button');
            btn.className = 'rank-btn';
            // Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ Ú©Ø¯ Û±
            btn.innerHTML = `Ø±ØªØ¨Ù‡ ${r} <small style="color:var(--green)">+${reward} ÙˆØ§ÙÙ„</small>`;
            btn.onclick = () => handleWin(r);
            grid.appendChild(btn);
        }
        const loseBtn = document.createElement('button');
        loseBtn.className = 'rank-btn btn-loss';
        // Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ Ú©Ø¯ Û±
        loseBtn.innerHTML = `ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ ${stage} Ø¨Ø§Ø®ØªÙ… <small>+1 ÙˆØ§ÙÙ„ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†</small>`;
        loseBtn.onclick = () => handleLoss();
        grid.appendChild(loseBtn);

        // Advisor
        updateAdvisor(gap);
        updateHistoryList();
    }

    // --- Ù…ØªÙ†â€ŒÙ‡Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø§Ø² Ú©Ø¯ Û± Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯ ---
    function updateAdvisor(gap) {
        const el = document.getElementById('advisorText');
        const total = state.total;
        el.style.border = "1px dashed #444"; el.style.background = "#202020";

        if (total >= 95) {
            el.innerHTML = `<span style="color:var(--red); font-weight:bold;">â›” Ø³Ù‚Ù Ù¾Ø± Ø´Ø¯! (Û¹Ûµ+)</span>`;
            el.style.borderColor = "var(--red)";
            el.style.background = "rgba(255, 82, 82, 0.1)";
        } else if (total === state.target) {
            // Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ú©Ø¯ Û±
            el.innerHTML = `<span style="color:var(--green); font-weight:bold;">ğŸ‰ Ø±Ø³ÛŒØ¯ÛŒÙ… Ø¨Ù‡ Ù‡Ø¯Ù!</span><br>Ø­Ø§Ù„Ø§ ÛŒÙ‡ Ø±Ø§Ù† Ú©Ø§Ù…Ù„ (Perfect Run) Ø¨Ø±Ùˆ.`;
            el.style.borderColor = "var(--green)";
            el.style.background = "rgba(0, 230, 118, 0.1)";
        } else if (total + 1 === 95) {
            // Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ú©Ø¯ Û±
            el.innerHTML = `<span style="color:var(--red); font-weight:bold;">âš ï¸ Ø®Ø·Ø± ØªÙ„Ù‡!</span><br>Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø¨Ø§Ø²ÛŒ. Ø­ØªÙ…Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø³ØªÛŒØ¬ Û± Ø±Ùˆ Ø¨Ø¨Ø±ÛŒ.`;
            el.style.borderColor = "var(--red)";
        } else {
            // Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ùˆ ÙØ§Ø±Ø³ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª
            let msg = "";
            if (gap >= 73) msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--accent)">Deep Run</b><br>(ØªØ§ Ø§Ø³ØªÛŒØ¬ Û´ Ø¨Ø¨Ø±ØŒ ÙˆÙ„ÛŒ Ø§Ø³ØªÛŒØ¬ Ûµ Ø±Ùˆ Ø¨Ø¨Ø§Ø²)`;
            else if (gap >= 16) msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--accent)">Short Run</b><br>(Ø§Ø³ØªÛŒØ¬ Û± Ø±Ùˆ Ø¨Ø¨Ø±ØŒ ÙˆÙ„ÛŒ Ø§Ø³ØªÛŒØ¬ Û² Ø±Ùˆ Ø¨Ø¨Ø§Ø²)`;
            else msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--yellow)">Gap Fill</b><br>(${gap} Ø¨Ø§Ø± Ù¾Ø´Øª Ø³Ø± Ù‡Ù… ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ Û± Ø¨Ø¨Ø§Ø²)`;
            el.innerHTML = msg;
        }
    }

    function updateHistoryList() {
        const list = document.getElementById('historyList');
        if (state.history.length === 0) {
            list.innerHTML = '<div style="text-align:center; font-size:0.8rem;">Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
            return;
        }
        const recent = state.history.slice().reverse().slice(0, 10);
        list.innerHTML = recent.map(h => `
            <div class="log-item">
                <span>${h.desc || 'ÙØ¹Ø§Ù„ÛŒØª'}</span>
                <span class="${h.type==='win'?'log-green':'log-red'}">${h.gain>0?'+'+h.gain:h.gain}</span>
            </div>
        `).join('');
    }

    function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }
</script>
</body>
</html>
