<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙˆØ§ÙÙ„</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --bg: #0f0f0f; 
            --card: #1a1a1a; 
            --accent: #bb86fc;
            --accent-glow: rgba(187, 134, 252, 0.3);
            --green: #00e676; 
            --green-glow: rgba(0, 230, 118, 0.4);
            --red: #ff5252; 
            --red-glow: rgba(255, 82, 82, 0.4);
            --text: #ffffff; 
            --sub: #b0b0b0;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 15px;
            display: flex; justify-content: center;
            touch-action: manipulation; 
            overflow-x: hidden;
        }
        .app-container {
            width: 100%; max-width: 450px;
            background: var(--card); padding: 20px;
            border-radius: 24px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; gap: 18px;
            border: 1px solid #333;
            position: relative;
        }
        
        /* --- Ù‡Ø¯Ø± Ùˆ Ø¯Ú©Ù…Ù‡ Info --- */
        h1 {
            text-align: center; color: var(--accent); 
            font-size: 1.1rem; /* Ø³Ø§ÛŒØ² Ú©Ù…ØªØ± */
            margin: 5px 0 0 0;
            text-shadow: 0 0 10px var(--accent-glow);
            padding: 0 40px; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø·Ø±ÙÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„ */
            line-height: 1.6;
        }

        .info-btn {
            position: absolute; top: 15px; left: 15px;
            width: 30px; height: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--accent); color: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; z-index: 10;
            animation: pulse-glow 2.5s infinite;
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(187, 134, 252, 0.4); }
            50% { box-shadow: 0 0 10px 2px rgba(187, 134, 252, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(187, 134, 252, 0); }
        }

        /* --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø± --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box {
            background: #252525; padding: 12px; border-radius: 16px; text-align: center;
            border: 1px solid #333; position: relative; overflow: hidden;
        }
        .stat-label { font-size: 0.7rem; color: var(--sub); margin-bottom: 5px; }
        .stat-value { font-size: 1.6rem; font-weight: 900; letter-spacing: 1px; transition: color 0.3s; }
        .val-green { color: var(--green); text-shadow: 0 0 10px var(--green-glow); }
        
        /* Ø§ÙÚ©Øª ÙÙ„Ø´ Ø²Ø¯Ù† Ù…ÙˆÙ‚Ø¹ ØªØºÛŒÛŒØ± Ø¹Ø¯Ø¯ */
        @keyframes flash-green { 0% { background-color: rgba(0,230,118,0); } 50% { background-color: rgba(0,230,118,0.2); } 100% { background-color: rgba(0,230,118,0); } }
        .flash-update { animation: flash-green 0.4s ease-out; }

        /* --- ÙˆÛŒØ²Ø§Ø±Ø¯ (Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ) --- */
        .wizard-card {
            background: #222; border-radius: 20px; padding: 18px;
            border: 1px solid #333; position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            min-height: 260px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø´ */
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±Ù‚ Ø²Ø¯Ù† */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .stage-header {
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 15px; gap: 6px;
        }
        .stage-title { font-size: 1.2rem; font-weight: bold; color: var(--text); }
        .stage-badge { 
            background: rgba(187, 134, 252, 0.1); color: var(--accent); 
            padding: 3px 12px; border-radius: 20px; font-size: 0.8rem; 
            border: 1px solid rgba(187, 134, 252, 0.3);
        }
        
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .rank-btn {
            border: none; border-radius: 14px; padding: 14px 8px;
            color: #fff; font-family: 'Vazirmatn', sans-serif; font-size: 0.95rem;
            cursor: pointer; position: relative; transition: transform 0.1s;
            background: linear-gradient(145deg, #333, #2a2a2a); border: 1px solid #444;
        }
        .rank-btn:active { transform: scale(0.95); }
        .rank-btn small { display: block; font-size: 0.7rem; opacity: 0.7; margin-top: 3px; }
        
        .btn-loss { 
            grid-column: span 2; background: linear-gradient(145deg, #2d1a1a, #251515);
            color: var(--red); border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .wizard-controls {
            display: flex; justify-content: space-between; margin-top: 15px; padding-top: 12px; 
            border-top: 1px solid #333;
        }
        .ctrl-btn {
            background: transparent; border: none; color: var(--sub); 
            font-family: inherit; font-size: 0.8rem; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; padding: 8px;
        }

        /* --- Ù…Ø´Ø§ÙˆØ± Ùˆ ØªØ§Ø±Ú¯Øª --- */
        .advisor-box {
            font-size: 0.85rem; color: var(--sub); text-align: center;
            padding: 12px; border-radius: 12px; background: #202020; 
            border: 1px dashed #444; line-height: 1.6;
        }

        .target-control {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: #222; padding: 5px; border-radius: 12px; margin-top: 5px;
            border: 1px solid #333; width: fit-content; margin: 5px auto;
        }
        .t-btn {
            width: 35px; height: 35px; border-radius: 8px; border: none;
            background: #333; color: #fff; font-size: 1.2rem; cursor: pointer;
        }
        .t-btn:disabled { background: #1a1a1a; color: #444; cursor: not-allowed; }
        .t-display { font-size: 1.3rem; font-weight: 900; min-width: 40px; text-align: center; }

        /* --- Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ú©Ø´ÙˆÛŒÛŒ) --- */
        .history-drawer {
            background: #1a1a1a; border-top: 1px solid #333;
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            border-radius: 0 0 24px 24px; margin: 0 -20px -20px -20px; /* Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† */
        }
        .history-content { padding: 15px; }
        .log-item {
            display: flex; justify-content: space-between; font-size: 0.8rem;
            padding: 6px 0; border-bottom: 1px solid #252525; color: #aaa;
        }
        .log-green { color: var(--green); } .log-red { color: var(--red); }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§Ù‡Ù†Ù…Ø§ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100; padding: 20px;
        }
        .modal-content {
            background: #1c1c1c; width: 100%; max-width: 380px;
            border-radius: 20px; padding: 25px; border: 1px solid var(--accent);
            box-shadow: 0 0 30px rgba(187, 134, 252, 0.2);
            color: #eee; text-align: right;
        }
        .modal-close {
            float: left; background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
        }

    </style>
</head>
<body>

<div class="app-container">
    <div class="info-btn" onclick="openHelp()">i</div>
    <h1>ğŸ§‡ Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙˆØ§ÙÙ„ ğŸ§‡</h1>

    <div class="dashboard">
        <div class="stat-box" id="totalBox">
            <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§ÙÙ„Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§ Ø§Ù„Ø§Ù† Ú¯Ø±ÙØªÛŒ</div>
            <div class="stat-value val-green" id="totalDisplay">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ÙØ§ØµÙ„Ù‡ ØªØ§ Ù‡Ø¯Ù</div>
            <div class="stat-value" style="color:#ffeb3b" id="gapDisplay">94</div>
        </div>
    </div>

    <div class="wizard-card">
        <div id="wizardContent" class="fade-in">
            <div class="stage-header">
                <span class="stage-title" id="stageTitle">Ø±ØªØ¨Ù‡â€ŒØª ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ Û±</span>
                <span class="stage-badge" id="currentRunBadge">ÙˆØ§ÙÙ„Ø§ÛŒ Ø§ÛŒÙ† Ø±Ø§Ù†: Û°</span>
            </div>

            <div class="rank-grid" id="buttonsArea"></div>
        </div>

        <div class="wizard-controls">
            <button class="ctrl-btn" id="btnBack" onclick="goBackStep()">â†©ï¸ Ø§ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ÛŒ</button>
            <button class="ctrl-btn" style="color:var(--accent);" onclick="toggleHistory()">ğŸ“œ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
        </div>
    </div>

    <div class="advisor-box" id="advisorText">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</div>

    <div style="text-align:center;">
        <div class="target-control">
            <button class="t-btn" id="btnMinus" onclick="changeTarget(-1)">âˆ’</button>
            <div class="t-display" id="targetVal">94</div>
            <button class="t-btn" id="btnPlus" onclick="changeTarget(1)">+</button>
        </div>
    </div>

    <div style="text-align:center; color:#444; font-size:0.7rem; margin-top:10px; cursor:pointer;" onclick="resetAll()">ğŸ—‘ï¸ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</div>

    <div class="history-drawer" id="historyDrawer">
        <div class="history-content" id="historyList">
            <div style="text-align:center; font-size:0.8rem;">Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="helpModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeHelp()">âœ•</button>
        <h3 style="color:var(--accent); margin-top:0;">Ø±Ø§Ù‡Ù†Ù…Ø§ ğŸ§‡</h3>
        <p style="font-size:0.9rem; line-height:1.7; color:#ccc;">
            Ù‡Ø¯Ù: Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ <b>Û¹Û´ ÙˆØ§ÙÙ„</b> (Ù†Ù‡ Û¹Ûµ).<br><br>
            ğŸ”¹ <b>Deep Run:</b> Ø§Ø³ØªÛŒØ¬ Û± ØªØ§ Û´ Ø¨Ø±Ù†Ø¯Ù‡ØŒ Ø§Ø³ØªÛŒØ¬ Ûµ Ø¨Ø§Ø²Ù†Ø¯Ù‡.<br>
            ğŸ”¹ <b>Gap Fill:</b> Ø¨Ø§Ø®Øª Ø³Ø±ÛŒØ¹ Ø¯Ø± Ø§Ø³ØªÛŒØ¬ Û±.<br><br>
            ÙˆÙ‚ØªÛŒ Ø¨Ù‡ Û¹Û´ Ø±Ø³ÛŒØ¯ÛŒØŒ ÛŒÚ© Ø¯ÙˆØ± Ú©Ø§Ù…Ù„ Ø¨Ø§Ø²ÛŒ Ú©Ù† Ùˆ Ù‡Ù…Ù‡ Ø±Ùˆ Ø¨Ø¨Ø±!
        </p>
    </div>
</div>

<script>
    const REWARDS = {1: 10, 2: 12, 3: 14, 4: 16, 5: 18};
    const BONUS = {1: 5, 2: 4, 3: 3, 4: 2};
    const MIN_TARGET = 60; const MAX_TARGET = 94;

    let state = { total: 0, target: 94, currentStage: 1, runScore: 0, history: [] };

    window.onload = () => {
        const saved = localStorage.getItem('waffleState_v11');
        if (saved) state = JSON.parse(saved);
        if(state.target > MAX_TARGET) state.target = MAX_TARGET;
        if(state.target < MIN_TARGET) state.target = MIN_TARGET;
        renderUI();
    };

    function save() {
        localStorage.setItem('waffleState_v11', JSON.stringify(state));
        renderUI();
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¢Ù†ÛŒ ---
    function handleWin(rank) {
        const gain = REWARDS[state.currentStage] + BONUS[rank];
        
        // 1. Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¢Ù†ÛŒ Ø¨Ù‡ Ú©Ù„
        state.total += gain;
        
        // 2. Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¢Ù†Ø¯Ùˆ)
        state.history.push({ 
            stage: state.currentStage, 
            gain: gain, 
            type: 'win',
            desc: `Ø¨Ø±Ø¯ Ø¯Ø± S${state.currentStage} (Ø±ØªØ¨Ù‡ ${rank})`
        });

        // 3. Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø±Ø§Ù†
        state.runScore += gain;
        state.currentStage++;

        // Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
        triggerAnimation();
        flashTotal();

        if (state.currentStage > 5) {
            setTimeout(() => {
                alert("ğŸ‰ Ø±Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡.");
                resetRunState();
                save();
            }, 300);
        } else {
            save();
        }
    }

    function handleLoss() {
        // Ø¯Ø± Ø¨Ø§Ø®ØªØŒ ÙÙ‚Ø· 1 ÙˆØ§ÙÙ„ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ú†ÙˆÙ† Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒÙ Ø§ÛŒÙ† Ø±Ø§Ù†ØŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯Ù†Ø¯)
        state.total += 1;
        
        state.history.push({
            stage: state.currentStage,
            gain: 1,
            type: 'loss',
            desc: `Ø¨Ø§Ø®Øª Ø¯Ø± S${state.currentStage}`
        });

        triggerAnimation();
        flashTotal();
        
        // Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†
        resetRunState();
        save();
    }

    function resetRunState() {
        state.currentStage = 1;
        state.runScore = 0;
    }

    function goBackStep() {
        if (state.history.length === 0) return;
        const lastMove = state.history.pop();
        
        // Ú©Ø³Ø± Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¢Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
        state.total -= lastMove.gain;
        
        // Ø§Ú¯Ø± Ø¢Ø®Ø±ÛŒÙ† Ø­Ø±Ú©Øª Ø¨Ø±Ø¯ Ø¨ÙˆØ¯ØŒ Ø¨Ø§ÛŒØ¯ Ø±Ø§Ù† Ø§Ø³Ú©ÙˆØ± Ù‡Ù… Ú©Ù… Ø¨Ø´Ù‡ Ùˆ Ø§Ø³ØªÛŒØ¬ Ø¨ÛŒØ§Ø¯ Ø¹Ù‚Ø¨
        if (lastMove.type === 'win') {
            state.runScore -= lastMove.gain;
            state.currentStage = lastMove.stage;
        } else {
            // Ø§Ú¯Ø± Ø¨Ø§Ø®Øª Ø¨ÙˆØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ø±Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨ÙˆØ¯. Ø§Ù…Ø§ Ú†ÙˆÙ† Ù…Ø§ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Ø±Ø§Ù† Ø±Ùˆ Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ
            // ÙÙ‚Ø· Ø¢Ø®Ø±ÛŒÙ† Ø­Ø±Ú©Øª (Ø¨Ø§Ø®Øª) Ø±Ùˆ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÙˆÙ†ÛŒÙ… Ùˆ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒØ®ÙˆØ§Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªØµÙ…ÛŒÙ… Ø¨Ú¯ÛŒØ±Ù‡.
            // (Ø¯Ø± Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ØŒ Ø¨Ø§Ø®Øª Ø§Ø³ØªÛŒØ¬ Ø±Ùˆ Û± Ù…ÛŒÚ©Ù†Ù‡. Ù¾Ø³ Ø¢Ù†Ø¯Ùˆ Ú©Ø±Ø¯Ù† Ø¨Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ù…Ø§ Ø±Ùˆ Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø¨Ù‡ Ø§Ø³ØªÛŒØ¬ Ù‚Ø¨Ù„ØŸ 
            //  Ù†Ù‡ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù…ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø§Ø³Øª. Ø³Ø§Ø¯Ù‡â€ŒØªØ±ÛŒÙ† Ø­Ø§Ù„Øª: Ø¨Ø§Ø®Øª Ø±Ùˆ Ù„ØºÙˆ Ù…ÛŒÚ©Ù†ÛŒÙ… Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ø± Ø§Ø³ØªÛŒØ¬ Û± Ø§Ø³Øª 
            //  ÛŒØ§ Ø¨Ù‡ØªØ±: Ø¨Ø±Ù…ÛŒÚ¯Ø±Ø¯ÛŒÙ… Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØªÛŒ Ú©Ù‡ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø®Øª Ø²Ø¯Ù‡ Ø´Ø¯).
            //  *Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ UX*: Ø¢Ù†Ø¯Ùˆ Ú©Ø±Ø¯Ù† Ø¨Ø§Ø®ØªØŒ ÙÙ‚Ø· Û± Ø§Ù…ØªÛŒØ§Ø² Ú©Ù… Ù…ÛŒÚ©Ù†Ø¯ Ùˆ Ø§Ø³ØªÛŒØ¬ Ø±Ø§ Ø±ÙˆÛŒ Û± Ù†Ú¯Ù‡ Ù…ÛŒØ¯Ø§Ø±Ø¯ 
            //  Ú†ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªÛŒØ¬ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø®Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯.*
            //  Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¢Ù†Ø¯Ùˆ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ø§ÛŒØ¯ Ú©Ù„ state Ø±Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯. 
            //  ÙØ¹Ù„Ø§: Ø¢Ù†Ø¯Ùˆ Ø¨Ø§Ø®Øª = Ú©Ø³Ø± Û± Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù…Ø§Ù†Ø¯Ù† Ø¯Ø± Ø§Ø³ØªÛŒØ¬ Û±.
        }
        
        save();
    }

    // --- UI Updates ---
    function triggerAnimation() {
        const el = document.getElementById('wizardContent');
        el.classList.remove('fade-in');
        void el.offsetWidth; // Trigger reflow
        el.classList.add('fade-in');
    }

    function flashTotal() {
        const el = document.getElementById('totalBox');
        el.classList.add('flash-update');
        setTimeout(() => el.classList.remove('flash-update'), 400);
    }

    function changeTarget(delta) {
        const newVal = state.target + delta;
        if (newVal >= MIN_TARGET && newVal <= MAX_TARGET) {
            state.target = newVal;
            save();
        }
    }

    function resetAll() {
        if(confirm("Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) { localStorage.clear(); location.reload(); }
    }

    // --- History Drawer ---
    function toggleHistory() {
        const drawer = document.getElementById('historyDrawer');
        if (drawer.style.maxHeight) { drawer.style.maxHeight = null; } 
        else { drawer.style.maxHeight = drawer.scrollHeight + "px"; }
    }

    // --- Render ---
    function renderUI() {
        // Stats
        document.getElementById('totalDisplay').innerText = state.total;
        const gap = state.target - state.total;
        document.getElementById('gapDisplay').innerText = gap;
        document.getElementById('targetVal').innerText = state.target;
        
        // Buttons logic
        document.getElementById('btnMinus').disabled = (state.target <= MIN_TARGET);
        document.getElementById('btnPlus').disabled = (state.target >= MAX_TARGET);

        // Wizard
        const stage = state.currentStage;
        document.getElementById('stageTitle').innerText = `Ø±ØªØ¨Ù‡â€ŒØª ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ ${stage}`;
        document.getElementById('currentRunBadge').innerText = `ÙˆØ§ÙÙ„Ø§ÛŒ Ø§ÛŒÙ† Ø±Ø§Ù†: ${state.runScore}`;
        document.getElementById('btnBack').disabled = (state.history.length === 0);

        // Generate Buttons
        const grid = document.getElementById('buttonsArea');
        grid.innerHTML = '';
        for (let r = 1; r <= 4; r++) {
            const reward = REWARDS[stage] + BONUS[r];
            const btn = document.createElement('button');
            btn.className = 'rank-btn';
            btn.innerHTML = `Ø±ØªØ¨Ù‡ ${r} <small style="color:var(--green)">+${reward}</small>`;
            btn.onclick = () => handleWin(r);
            grid.appendChild(btn);
        }
        const loseBtn = document.createElement('button');
        loseBtn.className = 'rank-btn btn-loss';
        loseBtn.innerHTML = `ØªÙˆÛŒ Ø§Ø³ØªÛŒØ¬ ${stage} Ø¨Ø§Ø®ØªÙ… <small>+1</small>`;
        loseBtn.onclick = () => handleLoss();
        grid.appendChild(loseBtn);

        // Advisor
        updateAdvisor(gap);
        updateHistoryList();
    }

    function updateAdvisor(gap) {
        const el = document.getElementById('advisorText');
        const total = state.total;
        el.style.border = "1px dashed #444"; el.style.background = "#202020";

        if (total >= 95) {
            el.innerHTML = `<span style="color:var(--red); font-weight:bold;">â›” Ø³Ù‚Ù Ù¾Ø± Ø´Ø¯! (Û¹Ûµ+)</span>`;
            el.style.borderColor = "var(--red)";
            el.style.background = "rgba(255, 82, 82, 0.1)";
        } else if (total === state.target) {
            el.innerHTML = `<span style="color:var(--green); font-weight:bold;">ğŸ‰ Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ… Perfect Run!</span><br>Ø§Ù„Ø§Ù† ÙˆÙ‚ØªØ´Ù‡ ØªØ§ Ø¢Ø®Ø± Ø¨Ø±ÛŒ Ùˆ Ù‡Ù…Ù‡ Ø±Ùˆ Ø¨Ø¨Ø±ÛŒ.`;
            el.style.borderColor = "var(--green)";
            el.style.background = "rgba(0, 230, 118, 0.1)";
        } else if (total + 1 === 95) {
            el.innerHTML = `<span style="color:var(--red); font-weight:bold;">âš ï¸ Ø®Ø·Ø± ØªÙ„Ù‡!</span> Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø¨Ø§Ø²ÛŒ.`;
            el.style.borderColor = "var(--red)";
        } else {
            let msg = "";
            if (gap >= 73) msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--accent)">Deep Run</b> (S1-S4 Ø¨Ø±Ø¯ØŒ S5 Ø¨Ø§Ø®Øª)`;
            else if (gap >= 16) msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--accent)">Short Run</b> (S1 Ø¨Ø±Ø¯ØŒ S2 Ø¨Ø§Ø®Øª)`;
            else msg = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: <b style="color:var(--yellow)">Gap Fill</b> (Ø³Ø±ÛŒØ¹ Ø¯Ø± S1 Ø¨Ø¨Ø§Ø²)`;
            el.innerHTML = msg;
        }
    }

    function updateHistoryList() {
        const list = document.getElementById('historyList');
        if (state.history.length === 0) {
            list.innerHTML = '<div style="text-align:center; font-size:0.8rem;">Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
            return;
        }
        // Ù†Ù…Ø§ÛŒØ´ Û±Û° Ø¢ÛŒØªÙ… Ø¢Ø®Ø±
        const recent = state.history.slice().reverse().slice(0, 10);
        list.innerHTML = recent.map(h => `
            <div class="log-item">
                <span>${h.desc || 'ÙØ¹Ø§Ù„ÛŒØª'}</span>
                <span class="${h.type==='win'?'log-green':'log-red'}">${h.gain>0?'+'+h.gain:h.gain}</span>
            </div>
        `).join('');
    }

    function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }
</script>
</body>
</html>
